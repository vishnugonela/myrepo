<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<vnfd generation="2.0" xmlns="http://www.hp.com/usage/vnfm/vnfd">
    <vnfd-id>VNFD_Descriptor_Affinity_Verizon_five</vnfd-id>
    <name>eIUM VNFD Example All In One</name>
    <description>Optional description: eIUM VNFD Example All In One</description>
    <provider>OpenStack</provider>
    <version>3.3</version>
    <connection-points>
        <connection-point id="ext-net">
            <name>testrouter</name>
            <description>Description: vnfm external router</description>
            <virtual-links>
                <virtual-link-ref>vl-vnfmnetwork-management-test</virtual-link-ref>
            </virtual-links>
            <external-virtual-link-name>ext-net</external-virtual-link-name>
            <properties>
                <properties-ref ref="referenceToThePropertyDefinedUnderVNFDElement"></properties-ref>
                <property id="testId">testValue</property>
            </properties>
        </connection-point>
    </connection-points>
    <virtual-links>
        <virtual-link id="vl-vnfmnetwork-management-test">
            <name>testnetwork</name>
            <description>the network to external core network for VNFM</description>
            <properties>
                <property id="openstack_network_gatewayIP">192.168.0.1</property>
                <property id="openstack_network_subnetAddress">192.168.0.0/16</property>
                <property id="openstack_network_subnetName">testsubnet</property>
                <property id="openstack_network_ipVersion">4</property>
            </properties>
        </virtual-link>
    </virtual-links>
    <vnfcs>
        <vnfc id="eIUM_EMS">
            <name>ned</name>
            <description>eIUM EMS</description>
            <virtual-links>
                <virtual-link-ref>vl-vnfmnetwork-management-test</virtual-link-ref>
            </virtual-links>
        </vnfc>
		<vnfc id="eIUM_Demo">
            <name>tully</name>
            <description>eIUM Demo</description>
            <virtual-links>
                <virtual-link-ref>vl-vnfmnetwork-management-test</virtual-link-ref>
            </virtual-links>
        </vnfc>
		
    </vnfcs>
    <flavors>
        <flavor id="F2">
            <name>Medium Deployment</name>
            <description>A Medium Deployment Example</description>
            <scaling>
                <settings>
                    <maxLevel>10</maxLevel>
                </settings>
                <aspects>
                    <scalingAspect id="base" name="base">
                        <description>BES machines</description>
                        <associatedGroup>
                            <vnfdElementGroup id="eiumbesgroupid">
                                <description>demo bes hosts</description>
                                <vdus>
                                    <vduRef ref="F2-eIUM_Demo" target="scaleout"/>
									
                                </vdus>
                            </vnfdElementGroup>
                        </associatedGroup>
                        <maxScaleLevel>5</maxScaleLevel>
                    </scalingAspect>
                </aspects>
            </scaling>
            <vdus>
                <vdu id="F2-eIUM_EMS" type="VM" name="">
                    <order>1</order>
                    <vnfc-ref>eIUM_EMS</vnfc-ref>
                    <vm-spec>
                        <uri>String</uri>
                    </vm-spec>
                    <vm-flavor>eium</vm-flavor>
                    <assignFloatingIP>true</assignFloatingIP>
					<affinity-groups>
					<affinity-group-ref>group-a</affinity-group-ref>
					</affinity-groups>
                    <script>
                        <description xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">script for eIUM EMS</description>
                        <property name="HostIP" value="${vdu.privateIp['testnetwork']}"/>
                        <property name="HostName" value="${vdu.serverName}" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
                        <property name="username" value="root" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
                        <property name="password" value="hwroot" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
                        <property name="vnfc_artifacts" value="/root/eium" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
                        <property name="destinationRemotePath" value="/root/eium" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
                        <property name="ium_instance_id" value="SIU_EMS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
                        <property name="HOSTID" value="${vdu.serverName}" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
                        <configure description="configure" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                            <sshPing attempts="20" host="${HostIP}" password="${password}" username="${username}"/>
                            <sshexec command="mkdir -p ${destinationRemotePath}" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <setHostId hostId="${HOSTID}"/>
                            <templateReplacement replacementDest="${vnfc_artifacts}/install_unix_demo_ems.opt_${HostName}" templateInputValue="INSTANCEID=${ium_instance_id},HOSTID=${HOSTID}" templatePath="${vnfc_artifacts}/install_unix_demo_ems.opt_template"/>
                            <scp file="${vnfc_artifacts}/local_policy.jar" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/US_export_policy.jar" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/CIS-9.0.iummodule.zip" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
							<scp file="${vnfc_artifacts}/jdk-8u102-linux-x64.tar.gz" password="${password}" todir="root@${HostIP}:/opt/" trust="true"/>
                            <scp file="${vnfc_artifacts}/IUM-9.0-setup-Linux.bin" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/MySql-5.7.17-9.0-Linux.iummodule.zip" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/license.config" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
							<scp file="${vnfc_artifacts}/install_unix_demo_ems.opt_${HostName}" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <sshexec command="echo ${HostIP} ${HostName}.novalocal ${HostName} &gt;&gt; /etc/hosts" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="rm -rf /etc/hostname" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="echo ${HostName} &gt;&gt; /etc/hostname" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="cd /opt/ ; tar -zxvf jdk-8u102-linux-x64.tar.gz " host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="sed -i 's/manage_etc_hosts: true/#manage_etc_hosts: true/g' /etc/cloud/cloud.cfg" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="mv /opt/jdk1.8.0_102/jre/lib/security/local_policy.jar /opt/jdk1.8.0_102/jre/lib/security/US_export_policy.jar /root/" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="mv ${destinationRemotePath}/local_policy.jar ${destinationRemotePath}/US_export_policy.jar /opt/jdk1.8.0_102/jre/lib/security/" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="cd ${destinationRemotePath}; chmod +x IUM-9.0-setup-Linux.bin; export JAVA_HOME=/opt/jdk1.8.0_102/bin/java; export PATH=$PATH:/opt/jdk1.8.0_102/bin; ./IUM-9.0-setup-Linux.bin -i silent -f ${destinationRemotePath}/install_unix_demo_ems.opt_${HostName}" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <setRegistryUrl registryUrl="http://${HostIP}:8158/"/>
                            <setEmsIP emsIP="${HostIP}"/>
                           

                        </configure>
                        <update description="update" level="1">
				<sshexec command="cd ${destinationRemotePath}; export JAVA_HOME=/opt/jdk1.8.0_102/bin/java; export PATH=$PATH:/opt/jdk1.8.0_102/bin; java -jar eIUM83VDRA12.SNAPSHOT-211aaa3e138.patch.unsigned /opt/${ium_instance_id} &amp;" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
			   <checkEiumActivation attempts="30" checkCommand="ps -ef|grep adminagentserver" checkResponse="/opt/${ium_instance_id}/bin/adminagentserver" host="${HostIP}" password="${password}" username="${username}"/>
                            <sshexec command="/etc/init.d/${ium_instance_id} start" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </update>
                        <update description="update" level="2">
                            <sshexec command="rm -rf /etc/varma" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="echo ${HostName} &gt;&gt; /etc/varma" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </update>
                        <update description="update" level="3">
                        </update>
                        <start description="start">
                            <sshexec command="/etc/init.d/${ium_instance_id} start" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </start>
                        <stop description="stop">
                            <sshexec command="/etc/init.d/${ium_instance_id} stop" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </stop>
                        <terminate description="terminate operation">
                            <echo message="terminate at application layer."/>
                        </terminate>
                        <target description="user defined" name="lbadd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                            <echo message="user defined target"/>
				<templateServiceBridge registryUrl="http://${HostIP}:8158/" templateFilePath="templates/factory/DRA/DRA_OCS.config" templateInputValue="SelectedHost=amazon,CollectorName=vDRAOCS1,ListenPort_CacheRefreshConnector=8089,DRAServerHost=amazon,DRAServer_IP=172.168.0.44,DRAServerRealm=laos,SERVERHOST_Environment=sessionserver,SERVERIP_Environment=172.168.0.44,SERVERREALM_Environment=laos,DiameterServer2_Host=hss2,ocs_BES1HOSTNAME_Environment=ocs_Bes1,ocs_BESREALM_Environment=laos,ocs_BES1IP1_Environment=172.168.0.22,URIocs_BES1_Environment=aaa://172.168.0.22:9091,STARTUPMODE_Properties=Manual,SERVERHOST_Environment=sessionserver,SERVERIP_Environment=172.168.0.44,SERVERREALM_Environment=laos,LinkInterface=[/templates/DRA/Common_OCS;/templates/DRA/sy]" />
						</target>
                        <target description="install a" name="drastart">
                            <echo message="install.a user defined target"/>
			    <sshexec command="/opt/${ium_instance_id}/bin/siucontrol -n vDRAOCS1 -c cleanproc" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="/opt/${ium_instance_id}/bin/siucontrol -n vDRAOCS1 -c startproc" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </target>
                        <target description="install b" name="install">
                            <echo message="install.b user defined target"/>
			     <sshexec command="cd ${destinationRemotePath}; export JAVA_HOME=/opt/jdk1.8.0_102/bin/java; export PATH=$PATH:/opt/jdk1.8.0_102/bin; java -jar eIUM90VDRA13.20170629-1445.patch /opt/${ium_instance_id} -A DRA.ExecuteChangelogs=true -A DRA.Database=siu20 -A DRA.TraceDataDatabase=true -A DRA.TraceDataDataBase=siu20 &amp; " host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="/etc/init.d/${ium_instance_id} start" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </target>
                        <preprocess target="instantiate">
                            <echo message="pre process for instanciate called"/>
                        </preprocess>
                        <postprocess target="instantiate">
                            <echo message="postprocess for instanciate called"/>
                        </postprocess>
                        <preprocess target="configure">
                            <echo message="pre process for configure called"/>
                        </preprocess>
                        <postprocess target="configure">
                            <echo message="postprocess for configure called"/>
                        </postprocess>
                        <preprocess target="user.defined.target">
                            <echo message="preprocess for user.defined.target called"/>
                        </preprocess>
                        <preprocess target="terminate">
                            <echo message="preprocess for terminate called"/>
                        </preprocess>
                        <postprocess target="terminate">
                            <echo message="postprocess for terminate called"/>
                        </postprocess>
                    </script>
                    <kpis>
                        <kpi id="KPI_1">
                            <description>Getting Free Memory</description>
                            <server>ned</server>
                            <group>MgmtStat</group>
                            <clazz>ServerStat</clazz>
                            <instance>Server</instance>
                            <attributeName>FreeMemory</attributeName>
                        </kpi>
                    </kpis>
                </vdu>
            <vdu id="F2-eIUM_Demo" type="VM">
                    <order>2</order>
                    <vnfc-ref>eIUM_Demo</vnfc-ref>
                    <num-instances>1</num-instances>
                    <scalability>
                        <min-instances>1</min-instances>
                        <max-instances>5</max-instances>
                    </scalability>
                    <vm-flavor>eium</vm-flavor>
                    <assignFloatingIP>false</assignFloatingIP>
					<affinity-groups>
					<affinity-group-ref>group-aa</affinity-group-ref>
					</affinity-groups>
                    <script>
                        <description>script for eIUM Demo</description>
                        <property name="HostIP" value="${vdu.privateIp['testnetwork']}"/>
                        <property name="HostName" value="${vdu.serverName}"/>
                        <property name="username" value="root"/>
                        <property name="password" value="hwroot"/>
                        <property name="vnfc_artifacts" value="/root/eium"/>
                        <property name="destinationRemotePath" value="/root/eium/"/>
                        <property name="ium_instance_id" value="SIU_Demo"/>
                        <property name="registry_url" value="${vnfr.registryUrl}"/>
                        <property name="HOSTID" value="${vdu.serverName}"/>
                        <property name="MHOST" value="${vnfr.emsIp}"/>
                        <configure description="configure">
                            <sshPing attempts="20" host="${HostIP}" password="${password}" username="${username}"/>
                            <sshexec command="mkdir -p ${destinationRemotePath}" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <templateReplacement replacementDest="${vnfc_artifacts}/install_unix_demo.opt_${HostName}" templateInputValue="INSTANCEID=${ium_instance_id},HOSTID=${HOSTID},IORURL=${registry_url},DATABASEURL=jdbc\:mysql\://${MHOST}\:3306/siu20,MHOST=${MHOST}" templatePath="${vnfc_artifacts}/install_unix_demo.opt_template"/>
                            <scp file="${vnfc_artifacts}/local_policy.jar" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/US_export_policy.jar" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/jdk-8u102-linux-x64.tar.gz" password="${password}" todir="root@${HostIP}:/opt/" trust="true"/>
                            <scp file="${vnfc_artifacts}/IUM-9.0-setup-Linux.bin" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/CIS-9.0.iummodule.zip" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
							<scp file="${vnfc_artifacts}/MySql-5.7.17-9.0-Linux.iummodule.zip" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <scp file="${vnfc_artifacts}/license.config" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                           
                            <scp file="${vnfc_artifacts}/install_unix_demo.opt_${HostName}" password="${password}" todir="root@${HostIP}:${destinationRemotePath}" trust="true"/>
                            <sshexec command="echo ${HostIP} ${HostName}.novalocal ${HostName} &gt;&gt; /etc/hosts" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="rm -rf /etc/hostname" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="echo ${HostName} &gt;&gt; /etc/hostname" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="cd /opt/ ; tar -zxvf jdk-8u102-linux-x64.tar.gz " host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="sed -i 's/manage_etc_hosts: true/#manage_etc_hosts: true/g' /etc/cloud/cloud.cfg" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="mv /opt/jdk1.8.0_102/jre/lib/security/local_policy.jar /opt/jdk1.8.0_102/jre/lib/security/US_export_policy.jar /root/" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="mv ${destinationRemotePath}/local_policy.jar ${destinationRemotePath}/US_export_policy.jar /opt/jdk1.8.0_102/jre/lib/security/" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            <sshexec command="cd ${destinationRemotePath}; chmod +x IUM-9.0-setup-Linux.bin; export JAVA_HOME=/opt/jdk1.8.0_102/bin/java; export PATH=$PATH:/opt/jdk1.8.0_102/bin; ./IUM-9.0-setup-Linux.bin -i silent -f ${destinationRemotePath}/install_unix_demo.opt_${HostName}" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                            
                            
                        </configure>
                        <scaleout description="scaleOut" level="1">
                            <echo message="scale out called on rob machine"/>
                        </scaleout>
						<scaleout description="scaleOut" level="2">
                            <echo message="scale out called on sansa machine"/>
                        </scaleout>
                        <scalein description="scaleIn" level="1">
                            <echo message="scale in called on rob machine"/>
                        </scalein>
						<scalein description="scaleIn" level="2">
                            <echo message="scale in called on sansa machine"/>
                        </scalein>
                        <start description="start">
                            <sshexec command="/etc/init.d/${ium_instance_id} start" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </start>
                        <stop description="stop">
                            <sshexec command="/etc/init.d/${ium_instance_id} stop" host="${HostIP}" password="${password}" trust="true" username="${username}"/>
                        </stop>
                        <terminate description="terminate operation">
                            <echo message="terminate at application layer."/>
                        </terminate>
                    </script>
                </vdu>
				
			</vdus>
        </flavor>
    </flavors>
    <vnfIndicators>
        <kpi id="globalKPI" type="IUM" extension="HSS">
            <description>Getting CPU usage</description>
            <ttl>60</ttl>
            <properties>
                <property id="x">A</property>
                <property id="y">B</property>
                <property id="filterXYZ">BES*</property>
            </properties>
        </kpi>
    </vnfIndicators>
	<affinity-groups>
	<affinity-group name="group-a" type="affinity"/>
	<affinity-group name="group-aa" type="anti-affinity"/>
	</affinity-groups>
    <properties id="vim">
        <property id="providerId">openstack</property>
        <property id="region">regionOne</property>
        <property id="configDrive">true</property>
        <property id="userName">ium</property>
        <property id="credential">ium</property>
        <property id="tenantName">ium</property>
        <property id="endPoint">https://172.16.200.5:13000/v2.0</property>
        <property id="keyPairName">wkey</property>
        <property id="keyPairPublicKey">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCcbw9nwjUbExEfWDseYZklrX7nZlP2xhPDX5AeiL44Uxr2cAiSf9zQDHEeyOdTjO1W6/J4kYmz7HN6hAliorXn+nymsZ7YactGImWpmDSF34Ee1nuwXtLNJOnKPR28QHSyUvjMDxr1+iyZWnkhecQ9fFKRWJwJu9Au9b8rZFEqH0p3BzOypb8addwFOPVnalR6zHLrr5qiqd60hY9UXiwtbZgs+P1QtJUIeOI1s8o1+YOjgTIy5vfBfYtDqUCD6QKh5bvR2W9X64JApE1oaXP9S5I8pNzuoxk38lfSOmkEMbNzSYi3Ibm0l6tKDIx3vkcRjq4nCAZ6TYwS7yGaj/2p Generated-by-Nova
        </property>
        <property id="imageName">rhel67</property>
        <property id="volumeSize">50</property>
        <property id="deleteVolumeOnTermination">true</property>
        <property id="deleteSnapshotsBeforeVolume">true</property>
        <property id="bootSource">VOLUME</property>
        <property id="volumeCreateTimeout">1200</property>
        <property id="volumeAvailabilityZone">nova</property>
        <property id="instanceAvailabilityZone">nova</property>
        <property id="floatingIPNet">ext-net</property>
        <property id="modules">org.jclouds.logging.slf4j.config.SLF4JLoggingModule</property>
    </properties>
    <properties id="testEntry">
        <property id="testId">testValue</property>
    </properties>
</vnfd>
